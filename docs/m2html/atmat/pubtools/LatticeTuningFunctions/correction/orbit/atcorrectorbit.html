<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of atcorrectorbit</title>
  <meta name="keywords" content="atcorrectorbit">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="../../../../index.html">atmat</a> &gt; <a href="../../../index.html">pubtools</a> &gt; <a href="../../index.html">LatticeTuningFunctions</a> &gt; <a href="../index.html">correction</a> &gt; <a href="index.html">orbit</a> &gt; atcorrectorbit.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/LatticeTuningFunctions/correction/orbit&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>atcorrectorbit
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [rcor,inCOD,hs,vs]=atcorrectorbit(rerr,indBPM,indHCor,indVCor,inCOD,neigSteerer,correctflags,scalefactor,ModelRM,reforbit,steererlimit,printouttext) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">
 Closed orbit correction.

 function [...
    rcor,...           1) corrected lattice
    inCOD,...          2) initial COD (dpp is stored here)
    hs,vs...           3,4) total steerers strengths after correction
    ]=atcorrectorbit(...
     rerr,...          1) AT lattice to correct
     indBPM,...        2) Nbx1 bpm indexes
     indHCor,...       3) Nhx1 hor. cor indexes
     indVCor,...       4) Nvx1 ver. cor indexes
     inCOD,...         5) 6x1 initial COD guess
     neigSteerer,...   6) 2xNiter eigenvectors for correction H and V at
                          each iteration (default: [Nh/2 Nv/2])
     correctflags,...  7) correct [dpp mean0](default: [true true])
     scalefactor,...   8) scale factor to correction (default: 1.0)
     ModelRM,...       9) ModelRM.Orb(H/V)Cor = 4x1 cell of orbit response matrix
                          ModelRM.Orb(H/V)DPP = 6x1 array of orbit
                          response to dpp
                          if [] compute RM (default: [])
     reforbit,...      10) 2xNbpm reference orbit to correct to (default 0*2xNb)
     steererlimit      11) 2x1 limit of steerers abs(steerer)&lt;steererlimit
                           (default: [], no limits)
     printouttext      12) if 1 or true, display rms orbit
     )

 features impelemented:
 limit correctors strengths
 ddp correction
 sum of steerers = 0
 6D orbit with BPM errors
 initial coordinate
 correction to reference orbit refx refy
 use atsetfieldvalues, atgetcells


see also: qemsvd_mod findorbit6Err getresponsematrices</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="testorbitbump.html" class="code" title="">testorbitbump</a>	test errors and correction functions</li><li><a href="testorbitcorrection.html" class="code" title="">testorbitcorrection</a>	test errors and correction functions</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [rcor,inCOD,hs,vs]=atcorrectorbit(</a><span class="keyword">...</span>
0002     rerr,<span class="keyword">...</span>
0003     indBPM,<span class="keyword">...</span>
0004     indHCor,<span class="keyword">...</span>
0005     indVCor,<span class="keyword">...</span>
0006     inCOD,<span class="keyword">...</span>
0007     neigSteerer,<span class="keyword">...</span>
0008     correctflags,<span class="keyword">...</span>
0009     scalefactor,<span class="keyword">...</span>
0010     ModelRM,<span class="keyword">...</span>
0011     reforbit,<span class="keyword">...</span>
0012     steererlimit,<span class="keyword">...</span>
0013     printouttext)
0014 <span class="comment">%</span>
0015 <span class="comment">% Closed orbit correction.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% function [...</span>
0018 <span class="comment">%    rcor,...           1) corrected lattice</span>
0019 <span class="comment">%    inCOD,...          2) initial COD (dpp is stored here)</span>
0020 <span class="comment">%    hs,vs...           3,4) total steerers strengths after correction</span>
0021 <span class="comment">%    ]=atcorrectorbit(...</span>
0022 <span class="comment">%     rerr,...          1) AT lattice to correct</span>
0023 <span class="comment">%     indBPM,...        2) Nbx1 bpm indexes</span>
0024 <span class="comment">%     indHCor,...       3) Nhx1 hor. cor indexes</span>
0025 <span class="comment">%     indVCor,...       4) Nvx1 ver. cor indexes</span>
0026 <span class="comment">%     inCOD,...         5) 6x1 initial COD guess</span>
0027 <span class="comment">%     neigSteerer,...   6) 2xNiter eigenvectors for correction H and V at</span>
0028 <span class="comment">%                          each iteration (default: [Nh/2 Nv/2])</span>
0029 <span class="comment">%     correctflags,...  7) correct [dpp mean0](default: [true true])</span>
0030 <span class="comment">%     scalefactor,...   8) scale factor to correction (default: 1.0)</span>
0031 <span class="comment">%     ModelRM,...       9) ModelRM.Orb(H/V)Cor = 4x1 cell of orbit response matrix</span>
0032 <span class="comment">%                          ModelRM.Orb(H/V)DPP = 6x1 array of orbit</span>
0033 <span class="comment">%                          response to dpp</span>
0034 <span class="comment">%                          if [] compute RM (default: [])</span>
0035 <span class="comment">%     reforbit,...      10) 2xNbpm reference orbit to correct to (default 0*2xNb)</span>
0036 <span class="comment">%     steererlimit      11) 2x1 limit of steerers abs(steerer)&lt;steererlimit</span>
0037 <span class="comment">%                           (default: [], no limits)</span>
0038 <span class="comment">%     printouttext      12) if 1 or true, display rms orbit</span>
0039 <span class="comment">%     )</span>
0040 <span class="comment">%</span>
0041 <span class="comment">% features impelemented:</span>
0042 <span class="comment">% limit correctors strengths</span>
0043 <span class="comment">% ddp correction</span>
0044 <span class="comment">% sum of steerers = 0</span>
0045 <span class="comment">% 6D orbit with BPM errors</span>
0046 <span class="comment">% initial coordinate</span>
0047 <span class="comment">% correction to reference orbit refx refy</span>
0048 <span class="comment">% use atsetfieldvalues, atgetcells</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%see also: qemsvd_mod findorbit6Err getresponsematrices</span>
0052 
0053 
0054 
0055 <span class="comment">% response matrix kicks</span>
0056 kval=1e-5;
0057 delta=1e-3;
0058 
0059 alpha=mcf(rerr);
0060 indrfc=find(atgetcells(rerr,<span class="string">'Frequency'</span>));
0061 f0=rerr{indrfc(1)}.Frequency;
0062 
0063 <span class="comment">% default arguments</span>
0064 <span class="keyword">if</span> nargin&lt;12
0065     printouttext=true;
0066 <span class="keyword">end</span>
0067 <span class="keyword">if</span> nargin&lt;11
0068     steererlimit=[];
0069 <span class="keyword">end</span>
0070 
0071 <span class="keyword">if</span> nargin&lt;4
0072     <span class="keyword">if</span> printouttext
0073         disp(<span class="string">'get BPM and Correctors indexes'</span>); <span class="keyword">end</span>;
0074     indBPM=finc(atgetcells(rerr,<span class="string">'Class'</span>,<span class="string">'Monitor'</span>));
0075     indHCor=finc(atgetcells(rerr,<span class="string">'iscorH'</span>,<span class="string">'H'</span>));
0076     indVCor=finc(atgetcells(rerr,<span class="string">'iscorV'</span>,<span class="string">'V'</span>));
0077 <span class="keyword">end</span>
0078 
0079 <span class="keyword">if</span> nargin&lt;5
0080     inCOD=[0 0 0 0 0 0]';
0081 <span class="keyword">end</span>
0082 
0083 <span class="keyword">if</span> nargin&lt;6
0084     neigSteerer=[length(indHCor) length(indVCor)]/2;
0085 <span class="keyword">end</span>
0086 
0087 <span class="keyword">if</span> nargin&lt;7
0088     correctflags=[true true];
0089 <span class="keyword">end</span>
0090 
0091 <span class="keyword">if</span> nargin&lt;8
0092     <span class="keyword">if</span> printouttext
0093         disp(<span class="string">' --- scale set to 1.0'</span>); <span class="keyword">end</span>;
0094     scalefactor=1.0;
0095 <span class="keyword">end</span>
0096 
0097 <span class="keyword">if</span> nargin&lt;9
0098     <span class="keyword">if</span> printouttext, disp(<span class="string">' --- computing orbit Response matrix'</span>); <span class="keyword">end</span>;
0099     ModelRM=[];
0100 <span class="keyword">end</span>
0101 
0102 <span class="keyword">if</span> nargin&lt;10
0103     <span class="keyword">if</span> printouttext, disp(<span class="string">' --- reference orbit = 0'</span>); <span class="keyword">end</span>;
0104     reforbit=zeros(2,length(indBPM));
0105 <span class="keyword">end</span>
0106 
0107 <span class="keyword">if</span> scalefactor&lt;0 || scalefactor&gt;1
0108     <span class="keyword">if</span> printouttext
0109         disp(<span class="string">' --- scale factor out of range. Set to 1.0'</span>); <span class="keyword">end</span>;
0110     scalefactor=1.0;
0111 <span class="keyword">end</span>
0112 
0113 <span class="keyword">if</span> correctflags(1) <span class="comment">% dpp correction</span>
0114     rmsel=[1 2 3];
0115 <span class="keyword">else</span>
0116     rmsel=[1 2];
0117 <span class="keyword">end</span>
0118 
0119 <span class="comment">% load or compute response matrix</span>
0120 <span class="keyword">if</span> isempty(ModelRM)
0121     <span class="comment">% get orbit RM</span>
0122     <span class="keyword">if</span> printouttext
0123         disp(<span class="string">'get orbit RM'</span>); <span class="keyword">end</span>;
0124     
0125     ModelRM=getresponsematrices(<span class="keyword">...</span>
0126         rerr,<span class="keyword">...</span><span class="comment">          %1 AT lattice</span>
0127         indBPM,<span class="keyword">...</span><span class="comment">      %2 bpm indexes in at lattice</span>
0128         indHCor,<span class="keyword">...</span><span class="comment">     %3 h cor indexes</span>
0129         indVCor,<span class="keyword">...</span><span class="comment">     %4 v cor indexes</span>
0130         [],<span class="keyword">...</span><span class="comment">     %5 skew cor indexes</span>
0131         [],<span class="keyword">...</span><span class="comment">     %6 quad cor indexes</span>
0132         [],<span class="keyword">...</span><span class="comment">     %7 sext cor indexes</span>
0133         inCOD,<span class="keyword">...</span><span class="comment">       %8 initial coordinates</span>
0134         rmsel<span class="keyword">...</span><span class="comment">      %9 specifiy rm to be computed</span>
0135         );
0136     
0137     
0138     <span class="keyword">if</span> ~correctflags(1) <span class="comment">% dpp correction</span>
0139         ModelRM.OrbHDPP=[];
0140         ModelRM.OrbVDPP=[];
0141     <span class="keyword">end</span>
0142     
0143 <span class="keyword">end</span>
0144 
0145 ormH=ModelRM.OrbHCor;
0146 ormV=ModelRM.OrbVCor;
0147 <span class="comment">% kval=ModelRM.kval;</span>
0148 dppH=ModelRM.OrbHDPP;
0149 dppV=ModelRM.OrbVDPP;
0150 <span class="comment">% delta=ModelRM.delta;</span>
0151 
0152 <span class="comment">% get initial orbit</span>
0153 o=findorbit6Err(rerr,indBPM,inCOD);
0154 ox0=o(1,:);
0155 oy0=o(3,:);
0156 
0157 <span class="comment">%rerr0=rerr;</span>
0158 
0159 <span class="comment">% iterate correction</span>
0160 Niter=size(neigSteerer,1);
0161 <span class="keyword">for</span> iter=1:Niter
0162     
0163     <span class="keyword">if</span> printouttext
0164         disp([<span class="string">'Orbit correction iter '</span> num2str(iter,<span class="string">'%d, '</span>) <span class="string">'n-eig: '</span> num2str(neigSteerer(iter,:),<span class="string">'%d, '</span>)]);
0165     <span class="keyword">end</span>
0166     
0167     <span class="comment">% initial corrector strengths</span>
0168     corh0=atgetfieldvalues(rerr,indHCor,<span class="string">'PolynomB'</span>,{1,1});
0169     corv0=atgetfieldvalues(rerr,indVCor,<span class="string">'PolynomA'</span>,{1,1});
0170     
0171     <span class="comment">% get current orbit</span>
0172     o=findorbit6Err(rerr,indBPM,inCOD);
0173     ox=o(1,:);
0174     oy=o(3,:);
0175     
0176     <span class="comment">% subtract reference orbit</span>
0177     ox=ox-reforbit(1,:);
0178     oy=oy-reforbit(2,:);
0179     
0180     <span class="comment">% build RMs</span>
0181     <span class="keyword">if</span> correctflags(1) &amp;&amp; correctflags(2) <span class="comment">% dpp and mean0</span>
0182         RMH=[ [ormH{1};ones(size(indHCor))] [dppH';0] ];
0183         RMV=[ [ormV{3};ones(size(indVCor))] [dppV';0] ];
0184     <span class="keyword">elseif</span> correctflags(1) &amp;&amp; ~correctflags(2)<span class="comment">% dpp no mean 0</span>
0185         RMH=[ ormH{1} dppH' ];
0186         RMV=[ ormV{3} dppV' ];
0187     <span class="keyword">elseif</span> ~correctflags(1) &amp;&amp; correctflags(2) <span class="comment">% mean0 no dpp</span>
0188         RMH=[ormH{1};ones(size(indHCor))];
0189         RMV=[ormV{3};ones(size(indVCor))];
0190     <span class="keyword">elseif</span> ~correctflags(1) &amp;&amp; ~correctflags(2) <span class="comment">% no dpp no mean0</span>
0191         RMH=ormH{1};
0192         RMV=ormV{3};
0193     <span class="keyword">end</span>
0194     
0195     <span class="comment">% compute correction</span>
0196     <span class="keyword">if</span> correctflags(2) <span class="comment">% mean 0</span>
0197         dch=qemsvd_mod(RMH,[ox';0],neigSteerer(iter,1));
0198         dcv=qemsvd_mod(RMV,[oy';0],neigSteerer(iter,2));
0199     <span class="keyword">else</span> <span class="comment">% no constraint on correctors mean</span>
0200         dch=qemsvd_mod(RMH,ox',neigSteerer(iter,1));
0201         dcv=qemsvd_mod(RMV,oy',neigSteerer(iter,2));
0202     <span class="keyword">end</span>
0203     
0204     
0205     <span class="comment">% get total correctors values and apply scaling</span>
0206     <span class="keyword">if</span> correctflags(1)
0207         hs=corh0-dch(1:end-1)*scalefactor;
0208         vs=corv0-dcv(1:end-1)*scalefactor;
0209         <span class="comment">% energy deviation</span>
0210         dd=-dch(end);
0211     <span class="keyword">else</span>
0212         hs=corh0-dch*scalefactor;
0213         vs=corv0-dcv*scalefactor;
0214     <span class="keyword">end</span>
0215     
0216     <span class="comment">% limit steerers strengths</span>
0217     <span class="keyword">if</span> ~isempty(steererlimit)
0218         hs(abs(hs)&gt;steererlimit(1))=steererlimit(1);
0219         vs(abs(vs)&gt;steererlimit(2))=steererlimit(2);
0220     <span class="keyword">end</span>
0221     
0222     rtest=atsetfieldvalues(rerr,indHCor,<span class="string">'PolynomB'</span>,{1,1},hs);
0223     rtest=atsetfieldvalues(rtest,indVCor,<span class="string">'PolynomA'</span>,{1,1},vs);
0224     
0225    
0226     <span class="keyword">if</span> correctflags(1)
0227         
0228         rtest=atsetfieldvalues(rtest,indrfc,<span class="string">'Frequency'</span>,f0-alpha*(dd)*f0);
0229         
0230         <span class="keyword">if</span> printouttext
0231             disp([<span class="string">'Delta RF : '</span> num2str(-alpha*(dd)*f0) <span class="string">' Hz'</span>]);
0232         <span class="keyword">end</span>
0233     <span class="keyword">end</span>
0234     
0235     <span class="comment">%[~,t,~]=atlinopt(rtest,0,1);</span>
0236     t=tunechrom(rtest,0);
0237     <span class="keyword">if</span> not(isnan(t(1)) || isnan(t(2)))
0238         <span class="comment">% apply correction in lattice</span>
0239         rcor = rtest;
0240     <span class="keyword">else</span> 
0241         rcor = rerr;
0242         <span class="keyword">if</span> printouttext
0243             disp(<span class="string">'Orbit correction fails, stop at previous step.'</span>)
0244         <span class="keyword">end</span>
0245         <span class="keyword">break</span>
0246     <span class="keyword">end</span>
0247     
0248     <span class="comment">% lattice start point for next iteration</span>
0249     rerr=rcor;
0250 <span class="keyword">end</span>
0251 
0252 <span class="comment">% get current orbit</span>
0253 o=findorbit6Err(rcor,indBPM,inCOD);
0254 oxc=o(1,:);
0255 oyc=o(3,:);
0256 Lh=atgetfieldvalues(rcor,indHCor,<span class="string">'Length'</span>);
0257 Lv=atgetfieldvalues(rcor,indVCor,<span class="string">'Length'</span>);
0258 hsL=hs.*Lh;
0259 vsL=vs.*Lv;
0260 
0261 <span class="keyword">if</span> printouttext
0262     <span class="comment">% display results</span>
0263     disp([<span class="string">'      before'</span> <span class="string">'    '</span> <span class="string">'--&gt;'</span> <span class="string">'    '</span> <span class="string">'after'</span>])
0264     disp([<span class="string">'oX: '</span> num2str(std(ox0-reforbit(1,:))*1e6,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(oxc-reforbit(1,:))*1e6,<span class="string">'%3.3f'</span>) <span class="string">'um'</span>]);
0265     disp([<span class="string">'oY: '</span> num2str(std(oy0-reforbit(2,:))*1e6,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(oyc-reforbit(2,:))*1e6,<span class="string">'%3.3f'</span>) <span class="string">'um'</span>]);
0266     disp([<span class="string">'    '</span> <span class="string">'min'</span> <span class="string">'    '</span> <span class="string">'mean'</span> <span class="string">'    '</span> <span class="string">'max'</span>])
0267     disp([<span class="string">'hs:'</span>  num2str([min(hsL) mean(hsL) max(hsL)]*1e3,<span class="string">' %2.2f '</span>) <span class="string">' mrad'</span>])
0268     disp([<span class="string">'vs:'</span>  num2str([min(vsL) mean(vsL) max(vsL)]*1e3,<span class="string">' %2.2f '</span>) <span class="string">' mrad'</span>])
0269     disp([<span class="string">'dpp: '</span> num2str(inCOD(5))])
0270 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 05-Mar-2018 10:51:40 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>