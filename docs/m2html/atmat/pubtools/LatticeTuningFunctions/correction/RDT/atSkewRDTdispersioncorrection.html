<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of atSkewRDTdispersioncorrection</title>
  <meta name="keywords" content="atSkewRDTdispersioncorrection">
  <meta name="description" content="function [...">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="../../../../index.html">atmat</a> &gt; <a href="../../../index.html">pubtools</a> &gt; <a href="../../index.html">LatticeTuningFunctions</a> &gt; <a href="../index.html">correction</a> &gt; <a href="index.html">RDT</a> &gt; atSkewRDTdispersioncorrection.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/LatticeTuningFunctions/correction/RDT&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>atSkewRDTdispersioncorrection
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [...</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [rcor,inCOD,ss]=atSkewRDTdispersioncorrection(rerr,r0,indBPM,indSCor,inCOD,neigSteerer,correctflags,scalefactor,wdisp,ModelRM,steererlimit,printouttext) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> function [...
    rcor,...            1) corrected lattice
    inCOD,...           2) initial COD (dpp is stored here)
    hs,vs...            3) required steerers strengths (total)
    ]=atdispersionfreesteering(...
     rerr,...           1) AT lattice to correct
     r0, ...            2) 2xNbpm reference rdt to correct to
     indBPM,...         3) Nbx1 bpm indexes       (default: monitor)
     indSCor,...        4) Nsx1 skew. cor indexes (default: sextupole)
     inCOD,...          5) 6x1 initial COD guess  (default: 6x1 zero)
     neigSteerer,...    6) 2xNiter eigenvectors for correction H and V at
                          each iteration (default: [Nh/2 Nv/2])
     correctflags,...   7) correct [ mean0](default: [ true])
     scalefactor,...    8) scale factor to correction (default: 1.0)
     [wdispv],...
                        9) dispersion and tune weight:
                           dispersionH*wdisph and orbith*(1-wdisph-wtune)
                           dispersionV*wdispv and orbith*(1-wdispv)                          
                           (default: 0.7 0.1 0.7)
     ModelRM,...       10) ModelRM.Disp(N/S)Quad = 6x1 cell of dispersion 
                           response mat. if [] compute RM (default: [])
                           (default 0*2xNb, or from r0 if reftune is r0)
     steererlimit      11) 2x1 limit of steerers abs(steerer)&lt;steererlimit
                           (default: [], no limits)
     printouttext      12) if 1 or true, display rms orbit
     )

 features impelemented:
 - limit correctors strengths
 - ddp correction
 - sum of steerers = 0
 - 6D orbit with BPM errors
 - initial coordinate
 - correction to reference rdt tune dispersion from r0 lattice
 - retrival of normal and skew quadrupole components also from alignment
   errors and rotations
 - use atsetfieldvalues, atgetcells

 http://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.14.034002

see also: qemsvd_mod findorbit6Err getresponsematrices</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>	EQUIVALENTGRADIENTSFROMALIGNMENTS6D Estimated normal quad gradients from sext offsets</li><li><a href="semrdtresp_mod.html" class="code" title="function [f1,f2,skew]=semrdtresp_mod(mach,bpmidx,skewidx)">semrdtresp_mod</a>	SEMRDT compute resonance driving terms at BPM locations</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="testRDTdispersionfreesteering.html" class="code" title="">testRDTdispersionfreesteering</a>	test errors and correction functions</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [rcor,inCOD,ss]=atSkewRDTdispersioncorrection(</a><span class="keyword">...</span>
0002     rerr,<span class="keyword">...</span>
0003     r0,<span class="keyword">...</span>
0004     indBPM,<span class="keyword">...</span>
0005     indSCor,<span class="keyword">...</span>
0006     inCOD,<span class="keyword">...</span>
0007     neigSteerer,<span class="keyword">...</span>
0008     correctflags,<span class="keyword">...</span>
0009     scalefactor,<span class="keyword">...</span>
0010     wdisp,<span class="keyword">...</span>
0011     ModelRM,<span class="keyword">...</span>
0012     steererlimit,<span class="keyword">...</span>
0013     printouttext)
0014 <span class="comment">% function [...</span>
0015 <span class="comment">%    rcor,...            1) corrected lattice</span>
0016 <span class="comment">%    inCOD,...           2) initial COD (dpp is stored here)</span>
0017 <span class="comment">%    hs,vs...            3) required steerers strengths (total)</span>
0018 <span class="comment">%    ]=atdispersionfreesteering(...</span>
0019 <span class="comment">%     rerr,...           1) AT lattice to correct</span>
0020 <span class="comment">%     r0, ...            2) 2xNbpm reference rdt to correct to</span>
0021 <span class="comment">%     indBPM,...         3) Nbx1 bpm indexes       (default: monitor)</span>
0022 <span class="comment">%     indSCor,...        4) Nsx1 skew. cor indexes (default: sextupole)</span>
0023 <span class="comment">%     inCOD,...          5) 6x1 initial COD guess  (default: 6x1 zero)</span>
0024 <span class="comment">%     neigSteerer,...    6) 2xNiter eigenvectors for correction H and V at</span>
0025 <span class="comment">%                          each iteration (default: [Nh/2 Nv/2])</span>
0026 <span class="comment">%     correctflags,...   7) correct [ mean0](default: [ true])</span>
0027 <span class="comment">%     scalefactor,...    8) scale factor to correction (default: 1.0)</span>
0028 <span class="comment">%     [wdispv],...</span>
0029 <span class="comment">%                        9) dispersion and tune weight:</span>
0030 <span class="comment">%                           dispersionH*wdisph and orbith*(1-wdisph-wtune)</span>
0031 <span class="comment">%                           dispersionV*wdispv and orbith*(1-wdispv)</span>
0032 <span class="comment">%                           (default: 0.7 0.1 0.7)</span>
0033 <span class="comment">%     ModelRM,...       10) ModelRM.Disp(N/S)Quad = 6x1 cell of dispersion</span>
0034 <span class="comment">%                           response mat. if [] compute RM (default: [])</span>
0035 <span class="comment">%                           (default 0*2xNb, or from r0 if reftune is r0)</span>
0036 <span class="comment">%     steererlimit      11) 2x1 limit of steerers abs(steerer)&lt;steererlimit</span>
0037 <span class="comment">%                           (default: [], no limits)</span>
0038 <span class="comment">%     printouttext      12) if 1 or true, display rms orbit</span>
0039 <span class="comment">%     )</span>
0040 <span class="comment">%</span>
0041 <span class="comment">% features impelemented:</span>
0042 <span class="comment">% - limit correctors strengths</span>
0043 <span class="comment">% - ddp correction</span>
0044 <span class="comment">% - sum of steerers = 0</span>
0045 <span class="comment">% - 6D orbit with BPM errors</span>
0046 <span class="comment">% - initial coordinate</span>
0047 <span class="comment">% - correction to reference rdt tune dispersion from r0 lattice</span>
0048 <span class="comment">% - retrival of normal and skew quadrupole components also from alignment</span>
0049 <span class="comment">%   errors and rotations</span>
0050 <span class="comment">% - use atsetfieldvalues, atgetcells</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% http://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.14.034002</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%see also: qemsvd_mod findorbit6Err getresponsematrices</span>
0055 
0056 
0057 
0058 <span class="comment">% response matrix kicks</span>
0059 <span class="comment">%kval=1e-5;</span>
0060 delta=1e-3;
0061 
0062 <span class="comment">% default arguments</span>
0063 <span class="keyword">if</span> nargin&lt;12
0064     printouttext=true;
0065 <span class="keyword">end</span>
0066 <span class="keyword">if</span> nargin&lt;11
0067     steererlimit=[];
0068 <span class="keyword">end</span>
0069 
0070 <span class="keyword">if</span> nargin&lt;4
0071     <span class="keyword">if</span> printouttext
0072         disp(<span class="string">'get BPM and Correctors indexes'</span>); <span class="keyword">end</span>;
0073     indBPM=finc(atgetcells(rerr,<span class="string">'Class'</span>,<span class="string">'Monitor'</span>));
0074     indSCor=finc(atgetcells(rerr,<span class="string">'Class'</span>,<span class="string">'Sextupole'</span>));
0075 <span class="keyword">end</span>
0076 
0077 <span class="keyword">if</span> nargin&lt;5
0078     inCOD=[0 0 0 0 0 0]';
0079 <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> nargin&lt;6
0082     neigSteerer=length(indSCor)/2;
0083 <span class="keyword">end</span>
0084 
0085 <span class="keyword">if</span> nargin&lt;7
0086     correctflags=true;
0087 <span class="keyword">end</span>
0088 
0089 <span class="keyword">if</span> nargin&lt;8
0090     <span class="keyword">if</span> printouttext
0091         disp(<span class="string">' --- scale set to 1.0'</span>); <span class="keyword">end</span>;
0092     scalefactor=1.0;
0093 <span class="keyword">end</span>
0094 
0095 <span class="keyword">if</span> nargin&lt;9
0096     <span class="keyword">if</span> printouttext, disp(<span class="string">' ---wdispv=0.7'</span>); <span class="keyword">end</span>;
0097     wdisp=.7;
0098 <span class="keyword">end</span>
0099 
0100 <span class="keyword">if</span> nargin&lt;10
0101     <span class="keyword">if</span> printouttext, disp(<span class="string">' --- computing orbit Response matrix'</span>); <span class="keyword">end</span>;
0102     ModelRM=[];
0103 <span class="keyword">end</span>
0104 
0105 
0106 <span class="keyword">if</span> scalefactor&lt;0 || scalefactor&gt;1
0107     <span class="keyword">if</span> printouttext
0108         disp(<span class="string">' --- scale factor out of range. Set to 1.0'</span>); <span class="keyword">end</span>;
0109     scalefactor=1.0;
0110 <span class="keyword">end</span>
0111 
0112 
0113 <span class="comment">% load or compute response matrix</span>
0114 <span class="keyword">if</span> isempty(ModelRM)
0115     <span class="comment">% get orbit RM</span>
0116     <span class="keyword">if</span> printouttext
0117         disp(<span class="string">'get RM'</span>); <span class="keyword">end</span>;
0118     
0119     
0120         ModelRM=getresponsematrices(<span class="keyword">...</span>
0121             rerr,<span class="keyword">...</span><span class="comment">          %1 AT lattice</span>
0122             indBPM,<span class="keyword">...</span><span class="comment">      %2 bpm indexes in at lattice</span>
0123             [],<span class="keyword">...</span><span class="comment">     %3 h cor indexes</span>
0124             [],<span class="keyword">...</span><span class="comment">     %4 v cor indexes</span>
0125             indSCor,<span class="keyword">...</span><span class="comment">     %5 skew cor indexes</span>
0126             [],<span class="keyword">...</span><span class="comment">     %6 quad cor indexes</span>
0127             [],<span class="keyword">...</span>
0128             inCOD,<span class="keyword">...</span><span class="comment">       %7 initial coordinates</span>
0129             11 );       <span class="comment">%8 specifiy rm to be computed</span>
0130             
0131         
0132     
0133 <span class="keyword">end</span>
0134 
0135 <span class="comment">% load RM computed by getresponsematrices</span>
0136 
0137 drmS=ModelRM.DispSCor;
0138 
0139 <span class="comment">% quad RDT RM</span>
0140 [~,~,ind]=<a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>(rerr,inCOD);
0141 indAllSkew=ind;
0142 
0143 
0144 <span class="comment">% skew RDT RM</span>
0145 [respsx,respsz]=<a href="semrdtresp_mod.html" class="code" title="function [f1,f2,skew]=semrdtresp_mod(mach,bpmidx,skewidx)">semrdtresp_mod</a>(rerr,indBPM,indAllSkew);    <span class="comment">% RDT response matrix assumes K=1</span>
0146 SL=atgetfieldvalues(rerr,indAllSkew,<span class="string">'Length'</span>);          <span class="comment">% quadrupole lengths</span>
0147 SL(SL==0)=1;<span class="comment">% thin lens magnets</span>
0148 lengthsmat=repmat(SL',length(indBPM),1);
0149 respsx=respsx.*lengthsmat;
0150 respsz=respsz.*lengthsmat;
0151 
0152 [~,skcor]=ismember(indSCor,indAllSkew);
0153 rdtS=[<span class="keyword">...</span>
0154     real(respsx(:,skcor));<span class="keyword">...</span>
0155     imag(respsx(:,skcor));<span class="keyword">...</span>
0156     real(respsz(:,skcor));<span class="keyword">...</span>
0157     imag(respsz(:,skcor))];
0158 
0159 
0160 inCOD=[0 0 0 0 0 0]';
0161 [l,~,~]=atlinopt(r0,0,indBPM);
0162 refdispersion=arrayfun(@(a)a.Dispersion(3),l);
0163 
0164 
0165 [~,KSnoer,~]=<a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>(r0,inCOD);
0166 
0167 fx=respsx*KSnoer;
0168 fz=respsz*KSnoer;
0169 rdtvecs=[<span class="keyword">...</span>
0170     real(fx);<span class="keyword">...</span>
0171     imag(fx);<span class="keyword">...</span>
0172     real(fz);<span class="keyword">...</span>
0173     imag(fz)]';
0174 
0175 refrdt(1,:)=rdtvecs;
0176 
0177 
0178 
0179 <span class="comment">% get rdt vectors to correct</span>
0180 [~,KSi,~]=<a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>(rerr,inCOD);
0181 
0182 fx=respsx*KSi;
0183 fz=respsz*KSi;
0184 rs0=[<span class="keyword">...</span>
0185     real(fx);<span class="keyword">...</span>
0186     imag(fx);<span class="keyword">...</span>
0187     real(fz);<span class="keyword">...</span>
0188     imag(fz)]';
0189 
0190 
0191 alpha=mcf(rerr);
0192 indrfc=find(atgetcells(rerr,<span class="string">'Frequency'</span>));
0193 
0194 <span class="comment">% get initial dispersion</span>
0195 
0196 d=finddispersion6Err(rerr,indBPM,indrfc,alpha,delta,inCOD);
0197 dy0=d(3,:);
0198 
0199 <span class="comment">%rerr0=rerr;</span>
0200  ss0=atgetfieldvalues(rerr,indSCor,<span class="string">'PolynomA'</span>,{1,2});
0201     
0202 <span class="comment">% iterate correction</span>
0203 Niter=size(neigSteerer,1);
0204 <span class="keyword">for</span> iter=1:Niter
0205     
0206     <span class="keyword">if</span> printouttext
0207         disp([<span class="string">'RDT Disp. Tune Steering iter '</span> num2str(iter,<span class="string">'%d, '</span>) <span class="keyword">...</span>
0208             <span class="string">' n-eig: '</span> num2str(neigSteerer(iter,:),<span class="string">'%d, '</span>) <span class="keyword">...</span>
0209             <span class="string">' alpha: '</span> num2str(wdisp,<span class="string">'%2.2f '</span>)]);
0210     <span class="keyword">end</span>
0211     
0212     <span class="comment">% initial corrector strengths</span>
0213     cors0=atgetfieldvalues(rerr,indSCor,<span class="string">'PolynomA'</span>,{1,2});
0214     
0215     
0216     <span class="comment">% get current rdt vectors to correct</span>
0217     [~,KSe,~]=<a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>(rerr,inCOD);
0218     <span class="comment">%KQ=atgetfieldvalues(rerr,indAllQuad,'PolynomB',{1,2});</span>
0219     <span class="comment">%KS=atgetfieldvalues(rerr,indAllSkew,'PolynomA',{1,2});</span>
0220     
0221     fx=respsx*KSe;
0222     fz=respsz*KSe;
0223     rs=[<span class="keyword">...</span>
0224         real(fx);<span class="keyword">...</span>
0225         imag(fx);<span class="keyword">...</span>
0226         real(fz);<span class="keyword">...</span>
0227         imag(fz)]';
0228     
0229     <span class="comment">% get current dispersion</span>
0230     d=finddispersion6Err(rerr,indBPM,indrfc,alpha,delta,inCOD);
0231     dy=d(3,:);
0232  
0233     <span class="comment">% subtract reference orbit</span>
0234     rs=rs-refrdt(1,:);
0235     <span class="comment">% subtract reference dispersion</span>
0236     dy=dy-refdispersion(1,:);
0237     <span class="comment">% subtract reference tune</span>
0238 
0239     <span class="comment">% weigths between RDT, tune and dispersion</span>
0240     rs=rs*(1-wdisp(1));
0241     dy=dy*(wdisp(1));
0242     
0243     <span class="comment">% build RMs</span>
0244     <span class="keyword">if</span>  correctflags(1) <span class="comment">% mean0 no dpp</span>
0245         RMS=[rdtS*(1-wdisp(1));drmS{3}*(wdisp(1));ones(size(indSCor))];
0246     <span class="keyword">elseif</span> ~correctflags(1) <span class="comment">% no dpp no mean0</span>
0247         RMS=[rdtS*(1-wdisp(1));drmS{3}*(wdisp(1))];
0248     <span class="keyword">end</span>
0249     
0250     <span class="comment">% compute correction</span>
0251     <span class="keyword">if</span> correctflags(1) <span class="comment">% mean = 0</span>
0252         vecs=[rs dy 0]';
0253     <span class="keyword">else</span> <span class="comment">% no constraint on correctors mean</span>
0254         vecs=[rs dy]';
0255     <span class="keyword">end</span>
0256     
0257     dcs=qemsvd_mod(RMS,vecs,neigSteerer(iter,1));
0258     
0259     <span class="comment">% get total correctors values and apply scaling</span>
0260     
0261     ss=cors0-dcs*scalefactor;
0262     
0263     <span class="comment">% limit steerers strengths</span>
0264     <span class="keyword">if</span> ~isempty(steererlimit)
0265         ss(abs(ss)&gt;steererlimit(1))=steererlimit(2);
0266     <span class="keyword">end</span>
0267     
0268     <span class="comment">% apply correction in lattice</span>
0269     rcor=rerr;
0270     rcor=atsetfieldvalues(rcor,indSCor,<span class="string">'PolynomA'</span>,{1,2},ss);
0271     
0272     <span class="comment">% lattice start point for next iteration</span>
0273     rerr=rcor;
0274 <span class="keyword">end</span>
0275 
0276 
0277 <span class="comment">% get current rdt vectors to correct</span>
0278 [~,KS,~]=<a href="EquivalentGradientsFromAlignments6D.html" class="code" title="function [kn,ks,ind]=EquivalentGradientsFromAlignments6D(r,inCOD)">EquivalentGradientsFromAlignments6D</a>(rcor,inCOD);
0279 
0280 fx=respsx*KS;
0281 fz=respsz*KS;
0282 rsc=[<span class="keyword">...</span>
0283     real(fx);<span class="keyword">...</span>
0284     imag(fx);<span class="keyword">...</span>
0285     real(fz);<span class="keyword">...</span>
0286     imag(fz)]';
0287 
0288 <span class="comment">% get current dispersion</span>
0289 d=finddispersion6Err(rcor,indBPM,indrfc,alpha,delta,inCOD);
0290 dyc=d(3,:);
0291 
0292 
0293 <span class="keyword">if</span> printouttext
0294     <span class="comment">% display results</span>
0295     disp([<span class="string">'        before'</span> <span class="string">'    '</span> <span class="string">'--&gt;'</span> <span class="string">'    '</span> <span class="string">'after'</span>])
0296     disp([<span class="string">'rs: '</span> num2str(std(rs0-refrdt(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(rsc-refrdt(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">''</span>]);
0297     disp([<span class="string">'dY: '</span> num2str(std(dy0-refdispersion(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(dyc-refdispersion(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">'mm'</span>])
0298     disp([<span class="string">'    '</span> <span class="string">'min'</span> <span class="string">'    '</span> <span class="string">'mean'</span> <span class="string">'    '</span> <span class="string">'max'</span>])
0299     disp([<span class="string">'ss:'</span>  num2str([min(ss-ss0) mean(ss-ss0) max(ss-ss0)]*1e0,<span class="string">' %2.2f '</span>) <span class="string">' 1/m2'</span>])
0300     disp([<span class="string">'dpp: '</span> num2str(inCOD(5))])
0301     
0302 <span class="comment">%     figure;</span>
0303 <span class="comment">%     subplot(2,1,1);</span>
0304 <span class="comment">%     plot(rs0-refrdt(1,:),'r'); hold on;</span>
0305 <span class="comment">%     plot(rsc-refrdt(1,:),'b');</span>
0306 <span class="comment">%     legend('before','after')</span>
0307 <span class="comment">%     subplot(2,1,2);</span>
0308 <span class="comment">%     plot(dy0-refdispersion(1,:),'r'); hold on;</span>
0309 <span class="comment">%     plot(dyc-refdispersion(1,:),'b');</span>
0310     
0311 <span class="keyword">end</span>
0312 
0313 
0314 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 05-Mar-2018 10:51:40 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>