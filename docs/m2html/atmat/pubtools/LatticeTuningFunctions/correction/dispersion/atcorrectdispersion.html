<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of atcorrectdispersion</title>
  <meta name="keywords" content="atcorrectdispersion">
  <meta name="description" content="function [...">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="../../../../index.html">atmat</a> &gt; <a href="../../../index.html">pubtools</a> &gt; <a href="../../index.html">LatticeTuningFunctions</a> &gt; <a href="../index.html">correction</a> &gt; <a href="index.html">dispersion</a> &gt; atcorrectdispersion.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/LatticeTuningFunctions/correction/dispersion&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>atcorrectdispersion
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [...</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [rcor,inCOD,qs,ss]=atcorrectdispersion(rerr,indBPM,indQCor,indSCor,inCOD,neigSteerer,correctflags,scalefactor,ModelRM,refdispersion,correctorslimit,printouttext) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> function [...
    rcor,...           1) corrected lattice
    inCOD,...          2) initial COD (dpp is stored here)
    qs,ss...           3) required normal and skew quad. strengths (total)
    ]=atcorrectdispersion(...
     rerr,...          1) AT lattice to correct
     indBPM,...        2) Nbx1 bpm indexes
     indHCor,...       3) Nhx1 hor. cor indexes
     indVCor,...       4) Nvx1 ver. cor indexes
     inCOD,...         5) 6x1 initial COD guess
     neigSteerer,...   6) 2xNiter eigenvectors for correction H and V at
                          each iteration (default: [Nh/2 Nv/2])
     correctflags,...  7) correct [dpp mean0](default: [true true])
     scalefactor,...   8) scale factor to correction (default: 1.0)
     ModelRM,...       9) ModelRM.Orb(H/V)Cor = 4x1 cell of orbit response mat.
                          ModelRM.Orb(H/V)DPP = 6x1 array of orbit
                          response to dpp
                          if [] compute RM (default: [])
     refdispersion,...10) 2xNbpm reference dispersion to correct to 
                           (default rerr dispersion)
     correctorslimit  11) 2x1 limit of steerers abs(steerer)&lt;steererlimit
                           (default: [], no limits)
     printouttext     12) if 1 or true, display rms orbit
     )

 features impelemented:
 limit correctors strengths
 ddp correction
 sum of steerers = 0
 6D dispersion with BPM errors
 initial coordinates
 correction to reference dispersions refdispersion
 use atsetfieldvalues, atgetcells


see also: qemsvd_mod finddispersion6Err getresponsematrices</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="testdispersioncorrection.html" class="code" title="">testdispersioncorrection</a>	test errors and correction functions</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [rcor,inCOD,qs,ss]=atcorrectdispersion(</a><span class="keyword">...</span>
0002     rerr,<span class="keyword">...</span>
0003     indBPM,<span class="keyword">...</span>
0004     indQCor,<span class="keyword">...</span>
0005     indSCor,<span class="keyword">...</span>
0006     inCOD,<span class="keyword">...</span>
0007     neigSteerer,<span class="keyword">...</span>
0008     correctflags,<span class="keyword">...</span>
0009     scalefactor,<span class="keyword">...</span>
0010     ModelRM,<span class="keyword">...</span>
0011     refdispersion,<span class="keyword">...</span>
0012     correctorslimit,<span class="keyword">...</span>
0013     printouttext)
0014 <span class="comment">% function [...</span>
0015 <span class="comment">%    rcor,...           1) corrected lattice</span>
0016 <span class="comment">%    inCOD,...          2) initial COD (dpp is stored here)</span>
0017 <span class="comment">%    qs,ss...           3) required normal and skew quad. strengths (total)</span>
0018 <span class="comment">%    ]=atcorrectdispersion(...</span>
0019 <span class="comment">%     rerr,...          1) AT lattice to correct</span>
0020 <span class="comment">%     indBPM,...        2) Nbx1 bpm indexes</span>
0021 <span class="comment">%     indHCor,...       3) Nhx1 hor. cor indexes</span>
0022 <span class="comment">%     indVCor,...       4) Nvx1 ver. cor indexes</span>
0023 <span class="comment">%     inCOD,...         5) 6x1 initial COD guess</span>
0024 <span class="comment">%     neigSteerer,...   6) 2xNiter eigenvectors for correction H and V at</span>
0025 <span class="comment">%                          each iteration (default: [Nh/2 Nv/2])</span>
0026 <span class="comment">%     correctflags,...  7) correct [dpp mean0](default: [true true])</span>
0027 <span class="comment">%     scalefactor,...   8) scale factor to correction (default: 1.0)</span>
0028 <span class="comment">%     ModelRM,...       9) ModelRM.Orb(H/V)Cor = 4x1 cell of orbit response mat.</span>
0029 <span class="comment">%                          ModelRM.Orb(H/V)DPP = 6x1 array of orbit</span>
0030 <span class="comment">%                          response to dpp</span>
0031 <span class="comment">%                          if [] compute RM (default: [])</span>
0032 <span class="comment">%     refdispersion,...10) 2xNbpm reference dispersion to correct to</span>
0033 <span class="comment">%                           (default rerr dispersion)</span>
0034 <span class="comment">%     correctorslimit  11) 2x1 limit of steerers abs(steerer)&lt;steererlimit</span>
0035 <span class="comment">%                           (default: [], no limits)</span>
0036 <span class="comment">%     printouttext     12) if 1 or true, display rms orbit</span>
0037 <span class="comment">%     )</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% features impelemented:</span>
0040 <span class="comment">% limit correctors strengths</span>
0041 <span class="comment">% ddp correction</span>
0042 <span class="comment">% sum of steerers = 0</span>
0043 <span class="comment">% 6D dispersion with BPM errors</span>
0044 <span class="comment">% initial coordinates</span>
0045 <span class="comment">% correction to reference dispersions refdispersion</span>
0046 <span class="comment">% use atsetfieldvalues, atgetcells</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%see also: qemsvd_mod finddispersion6Err getresponsematrices</span>
0050 
0051 
0052 
0053 <span class="comment">% response matrix kicks</span>
0054 kval=1e-5;
0055 delta=1e-3;
0056 
0057 alpha=mcf(rerr);
0058 indrfc=find(atgetcells(rerr,<span class="string">'Frequency'</span>));
0059 f0=rerr{indrfc(1)}.Frequency;
0060 
0061 <span class="comment">% default arguments</span>
0062 <span class="keyword">if</span> nargin&lt;12
0063     printouttext=true;
0064 <span class="keyword">end</span>
0065 <span class="keyword">if</span> nargin&lt;11
0066     correctorslimit=[];
0067 <span class="keyword">end</span>
0068 
0069 <span class="keyword">if</span> nargin&lt;4
0070     <span class="keyword">if</span> printouttext
0071         disp(<span class="string">'get BPM and Correctors indexes'</span>); <span class="keyword">end</span>;
0072     indBPM=finc(atgetcells(rerr,<span class="string">'Class'</span>,<span class="string">'Monitor'</span>));
0073     indQCor=finc(atgetcells(rerr,<span class="string">'Class'</span>,<span class="string">'Quadrupole'</span>));
0074     indSCor=finc(atgetcells(rerr,<span class="string">'iscorS'</span>,<span class="string">'S'</span>));
0075 <span class="keyword">end</span>
0076 
0077 <span class="keyword">if</span> nargin&lt;5
0078     inCOD=[0 0 0 0 0 0]';
0079 <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> nargin&lt;6
0082     neigSteerer=[length(indQCor) length(indSCor)]/2;
0083 <span class="keyword">end</span>
0084 
0085 <span class="keyword">if</span> nargin&lt;7
0086     correctflags=[true true];
0087 <span class="keyword">end</span>
0088 
0089 <span class="keyword">if</span> nargin&lt;8
0090     <span class="keyword">if</span> printouttext
0091         disp(<span class="string">' --- scale set to 1.0'</span>); <span class="keyword">end</span>;
0092     scalefactor=1.0;
0093 <span class="keyword">end</span>
0094 
0095 <span class="keyword">if</span> nargin&lt;9
0096     <span class="keyword">if</span> printouttext, disp(<span class="string">' --- computing orbit Response matrix'</span>); <span class="keyword">end</span>;
0097     ModelRM=[];
0098 <span class="keyword">end</span>
0099 
0100 <span class="keyword">if</span> nargin&lt;10
0101      <span class="keyword">if</span> printouttext, disp(<span class="string">' --- reference dispersion = 0 V, rerr disp H'</span>); <span class="keyword">end</span>;
0102     refdispersion=zeros(size(indBPM),2);
0103     [l,~,~]=atlinopt(rerr,0,indBPM);
0104     refdispersion(1,:)=arrayfun(@(a)a.Dispersion(1),l);
0105 <span class="keyword">end</span>
0106 
0107 <span class="keyword">if</span> scalefactor&lt;0 || scalefactor&gt;1
0108     <span class="keyword">if</span> printouttext
0109         disp(<span class="string">' --- scale factor out of range. Set to 1.0'</span>); <span class="keyword">end</span>;
0110     scalefactor=1.0;
0111 <span class="keyword">end</span>
0112 
0113 
0114 <span class="keyword">if</span> correctflags(1) <span class="comment">% dpp correction</span>
0115     rmsel=[9 10 11];
0116 <span class="keyword">else</span>
0117     rmsel=[1 2];
0118 <span class="keyword">end</span>
0119 
0120 <span class="comment">% load or compute response matrix</span>
0121 <span class="keyword">if</span> isempty(ModelRM)
0122     <span class="comment">% get orbit RM</span>
0123     <span class="keyword">if</span> printouttext
0124         disp(<span class="string">'get orbit RM'</span>); <span class="keyword">end</span>;
0125     
0126     ModelRM=getresponsematrices(<span class="keyword">...</span>
0127         rerr,<span class="keyword">...</span><span class="comment">          %1 AT lattice</span>
0128         indBPM,<span class="keyword">...</span><span class="comment">      %2 bpm indexes in at lattice</span>
0129         [],<span class="keyword">...</span><span class="comment">     %3 h cor indexes</span>
0130         [],<span class="keyword">...</span><span class="comment">     %4 v cor indexes</span>
0131         indSCor,<span class="keyword">...</span><span class="comment">     %5 skew  cor indexes</span>
0132         indQCor,<span class="keyword">...</span><span class="comment">     %6 quad cor indexes</span>
0133         [],<span class="keyword">...</span>
0134         inCOD,<span class="keyword">...</span><span class="comment">       %7 initial coordinates</span>
0135         rmsel<span class="keyword">...</span><span class="comment">        %8 specifiy rm to be computed</span>
0136         );
0137     
0138     <span class="keyword">if</span> ~correctflags(1)
0139         
0140         ModelRM.DispHDPP=[];
0141         ModelRM.DispVDPP=[];
0142     <span class="keyword">end</span>
0143     
0144 <span class="keyword">end</span>
0145 
0146 drmH=ModelRM.DispQCor;
0147 drmV=ModelRM.DispSCor;
0148 <span class="comment">% kval=ModelRM.kval;</span>
0149 dppH=ModelRM.DispHDPP;
0150 dppV=ModelRM.DispVDPP;
0151 <span class="comment">% delta=ModelRM.delta;</span>
0152 alpha=mcf(rerr);
0153 indrfc=find(atgetcells(rerr,<span class="string">'Frequency'</span>));
0154      
0155 <span class="comment">% get initial dispersion</span>
0156 d=finddispersion6Err(rerr,indBPM,indrfc,alpha,delta,inCOD);
0157 dx0=d(1,:);
0158 dy0=d(3,:);
0159 
0160 qs0=atgetfieldvalues(rerr,indQCor,<span class="string">'PolynomB'</span>,{1,2});
0161 
0162 <span class="comment">% iterate correction</span>
0163 Niter=size(neigSteerer,1);
0164 <span class="keyword">for</span> iter=1:Niter
0165     
0166     <span class="keyword">if</span> printouttext
0167         disp([<span class="string">'Dispersion correction iter '</span> num2str(iter,<span class="string">'%d, '</span>) <span class="keyword">...</span>
0168             <span class="string">'n-eig: '</span> num2str(neigSteerer(iter,:),<span class="string">'%d, '</span>)]);
0169     <span class="keyword">end</span>
0170     
0171     <span class="comment">% initial corrector strengths</span>
0172     corq0=atgetfieldvalues(rerr,indQCor,<span class="string">'PolynomB'</span>,{1,2});
0173     cors0=atgetfieldvalues(rerr,indSCor,<span class="string">'PolynomA'</span>,{1,2});
0174     
0175     <span class="comment">% get current orbit</span>
0176     d=finddispersion6Err(rerr,indBPM,indrfc,alpha,delta,inCOD);
0177     dx=d(1,:);
0178     dy=d(3,:);
0179     
0180     <span class="comment">% subtract reference orbit</span>
0181     dx=dx-refdispersion(1,:);
0182     dy=dy-refdispersion(2,:);
0183     
0184     <span class="comment">% build RMs</span>
0185     <span class="keyword">if</span> correctflags(1) &amp;&amp; correctflags(2) <span class="comment">% dpp and mean0</span>
0186         RMH=[ [drmH{1};ones(size(indQCor))] [dppH';0] ];
0187         RMV=[ [drmV{3};ones(size(indSCor))] [dppV';0] ];
0188     <span class="keyword">elseif</span> correctflags(1) &amp;&amp; ~correctflags(2)<span class="comment">% dpp no mean 0</span>
0189         RMH=[ drmH{1} dppH' ];
0190         RMV=[ drmV{3} dppV' ];
0191     <span class="keyword">elseif</span> ~correctflags(1) &amp;&amp; correctflags(2) <span class="comment">% mean0 no dpp</span>
0192         RMH=[drmH{1};ones(size(indQCor))];
0193         RMV=[drmV{3};ones(size(indSCor))];
0194     <span class="keyword">elseif</span> ~correctflags(1) &amp;&amp; ~correctflags(2) <span class="comment">% no dpp no mean0</span>
0195         RMH=drmH{1};
0196         RMV=drmV{3};
0197     <span class="keyword">end</span>
0198     
0199     <span class="comment">% compute correction</span>
0200     <span class="keyword">if</span> correctflags(2) <span class="comment">% mean 0</span>
0201         dch=qemsvd_mod(RMH,[dx';0],neigSteerer(1));
0202         dcv=qemsvd_mod(RMV,[dy';0],neigSteerer(2));
0203     <span class="keyword">else</span> <span class="comment">% no constraint on correctors mean</span>
0204         dch=qemsvd_mod(RMH,dx',neigSteerer(1));
0205         dcv=qemsvd_mod(RMV,dy',neigSteerer(2));
0206     <span class="keyword">end</span>
0207     
0208     
0209     <span class="comment">% get total correctors values and apply scaling</span>
0210     <span class="keyword">if</span> correctflags(1)
0211         qs=corq0-dch(1:end-1)*scalefactor;
0212         ss=cors0-dcv(1:end-1)*scalefactor;
0213         <span class="comment">% energy deviation</span>
0214         dd=-dch(end);
0215     <span class="keyword">else</span>
0216         qs=corq0-dch*scalefactor;
0217         ss=cors0-dcv*scalefactor;
0218     <span class="keyword">end</span>
0219     
0220     <span class="comment">% limit correctors strengths</span>
0221     <span class="keyword">if</span> ~isempty(correctorslimit)
0222         qs(abs(qs)&gt;correctorslimit(1))=correctorslimit(1);
0223         ss(abs(ss)&gt;correctorslimit(2))=correctorslimit(2);
0224     <span class="keyword">end</span>
0225     
0226     <span class="comment">% apply correction in lattice</span>
0227     rcor=atsetfieldvalues(rerr,indQCor,<span class="string">'PolynomB'</span>,{1,2},qs);
0228     rcor=atsetfieldvalues(rcor,indSCor,<span class="string">'PolynomA'</span>,{1,2},ss);
0229     
0230     <span class="keyword">if</span> correctflags(1)
0231        
0232         rcor=atsetfieldvalues(rcor,indrfc,<span class="string">'Frequency'</span>,f0-alpha*(dd)*f0);
0233         
0234         <span class="keyword">if</span> printouttext
0235             disp([<span class="string">'Delta RF : '</span> num2str(-alpha*(dd)*f0) <span class="string">' Hz'</span>]);
0236         <span class="keyword">end</span>
0237     <span class="keyword">end</span>
0238     
0239     <span class="comment">% lattice start point for next iteration</span>
0240     rerr=rcor;
0241 <span class="keyword">end</span>
0242 
0243 <span class="comment">% get current orbit</span>
0244 d=finddispersion6Err(rcor,indBPM,indrfc,alpha,delta,inCOD);
0245 dxc=d(1,:);
0246 dyc=d(3,:);
0247 
0248 <span class="keyword">if</span> printouttext
0249     <span class="comment">% display results</span>
0250     disp([<span class="string">'before'</span> <span class="string">'    '</span> <span class="string">'--&gt;'</span> <span class="string">'    '</span> <span class="string">'after'</span>])
0251     disp([<span class="string">'dX: '</span> num2str(std(dx0-refdispersion(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(dxc-refdispersion(1,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">'mm'</span>])
0252     disp([<span class="string">'dY: '</span> num2str(std(dy0-refdispersion(2,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">' -&gt; '</span> num2str(std(dyc-refdispersion(2,:))*1e3,<span class="string">'%3.3f'</span>) <span class="string">'mm'</span>])
0253     disp([<span class="string">'    '</span> <span class="string">'min'</span> <span class="string">'    '</span> <span class="string">'mean'</span> <span class="string">'    '</span> <span class="string">'max'</span>])
0254     disp([<span class="string">'hs:'</span>  num2str([min(qs-qs0) mean(qs-qs0) max(qs-qs0)],<span class="string">' %2.4f '</span>) <span class="string">' 1/m2'</span>])
0255     disp([<span class="string">'vs:'</span>  num2str([min(ss) mean(ss) max(ss)],<span class="string">' %2.4f '</span>) <span class="string">' 1/m2'</span>])
0256     disp([<span class="string">'dpp: '</span> num2str(inCOD(5))])
0257 
0258 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 05-Mar-2018 10:51:40 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>