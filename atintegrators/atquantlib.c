#include <math.h>
#include "atrandom.c"
/*this is quite ugly....but avoids reading form file*/

static int nt = 347;
static double t[347][2] =
{{0.005               	,0.2088668402642263},
{0.006               	,0.22171632120150683},
{0.007               	,0.23316993091180688},
{0.008               	,0.24354693315131754},
{0.009000000000000001	,0.25306369171608795},
{0.01                	,0.2618744070550671},
{0.011               	,0.2700933085258619},
{0.012               	,0.2778076500433331},
{0.013000000000000001	,0.28508576256303186},
{0.014               	,0.2919822757842806},
{0.015               	,0.29854163340646267},
{0.016               	,0.30480053508376337},
{0.017               	,0.3107896787274743},
{0.018000000000000002	,0.31653503257565646},
{0.019               	,0.3220587828404265},
{0.02                	,0.3273800517920308},
{0.022               	,0.33747951537302223},
{0.024               	,0.34694335907657275},
{0.026               	,0.3558576769866132},
{0.027999999999999997	,0.364291300544661},
{0.03                	,0.3723002275126345},
{0.032               	,0.3799306986572044},
{0.034               	,0.38722139292484803},
{0.036               	,0.3942050301589875},
{0.038               	,0.400909564967831},
{0.04                	,0.407359091860323},
{0.041999999999999996	,0.41357454228616225},
{0.044               	,0.4195742289596816},
{0.046               	,0.42537427628444807},
{0.048               	,0.430988964580978},
{0.05                	,0.43643100822105646},
{0.052               	,0.44171178247132925},
{0.054               	,0.44684151009681544},
{0.056               	,0.451829416076053},
{0.057999999999999996	,0.4566838568121079},
{0.06                	,0.46141242877108085},
{0.062               	,0.4660220603947391},
{0.064               	,0.47051909031467265},
{0.066               	,0.4749093342705991},
{0.068               	,0.47919814265450433},
{0.07                	,0.48339045022886656},
{0.072               	,0.487490819274867},
{0.074               	,0.4915034771958881},
{0.076               	,0.495432349418385},
{0.078               	,0.4992810882856756},
{0.08                	,0.5030530985222352},
{0.082               	,0.5067515597506513},
{0.084               	,0.5103794464649192},
{0.086               	,0.5139395458021864},
{0.088               	,0.5174344733989452},
{0.09                	,0.5208666875781748},
{0.092               	,0.5242385020754927},
{0.094               	,0.5275520974831769},
{0.096               	,0.5308095315656026},
{0.098               	,0.5340127485784558},
{0.1                 	,0.537163587706187},
{0.105               	,0.5448227415936875},
{0.11                	,0.5521900402285459},
{0.11499999999999999 	,0.5592873809836058},
{0.12                	,0.5661341578851481},
{0.125               	,0.5727476391349153},
{0.13                	,0.5791432750163039},
{0.135               	,0.585334951183085},
{0.13999999999999999 	,0.591335198666127},
{0.145               	,0.5971553692632277},
{0.15                	,0.6028057830056258},
{0.155               	,0.6082958529222271},
{0.16                	,0.6136341912100141},
{0.165               	,0.6188287000731901},
{0.16999999999999998 	,0.6238866498372159},
{0.175               	,0.6288147464409036},
{0.18                	,0.6336191900104596},
{0.185               	,0.6383057259072643},
{0.19                	,0.6428796893923717},
{0.195               	,0.6473460448518068},
{0.2                 	,0.6517094203666389},
{0.205               	,0.6559741382821455},
{0.21                	,0.6601442423248094},
{0.215               	,0.6642235217294122},
{0.22                	,0.6682155327673581},
{0.225               	,0.6721236180085081},
{0.23                	,0.6759509235999174},
{0.235               	,0.6797004148040913},
{0.24                	,0.6833748900051709},
{0.245               	,0.6869769933627271},
{0.25                	,0.6905092262685255},
{0.255               	,0.6939739577410721},
{0.26                	,0.6973734338752037},
{0.265               	,0.7007097864490727},
{0.27                	,0.7039850407780611},
{0.275               	,0.7072011228942575},
{0.28                	,0.7103598661200904},
{0.285               	,0.7134630170983071},
{0.29                	,0.7165122413303359},
{0.295               	,0.7195091282721089},
{0.3                 	,0.7224551960290722},
{0.305               	,0.7253518956881163},
{0.31                	,0.7282006153199838},
{0.315               	,0.7310026836821056},
{0.32                	,0.7337593736486706},
{0.325               	,0.736471905391957},
{0.33                	,0.7391414493364982},
{0.335               	,0.7417691289054884},
{0.34                	,0.7443560230769127},
{0.345               	,0.7469031687651814},
{0.35                	,0.7494115630425245},
{0.355               	,0.7518821652130626},
{0.36                	,0.7543158987512504},
{0.365               	,0.7567136531153215},
{0.37                	,0.7590762854453887},
{0.375               	,0.7614046221549955},
{0.38                	,0.7636994604241285},
{0.385               	,0.7659615696010084},
{0.39                	,0.768191692519341},
{0.395               	,0.770390546737143},
{0.4                 	,0.7725588257027426},
{0.401               	,0.7729888718571846},
{0.41100000000000003 	,0.7772246860214461},
{0.42100000000000004 	,0.7813464569334458},
{0.43100000000000005 	,0.7853589379169782},
{0.441               	,0.7892665903686343},
{0.451               	,0.7930736077993934},
{0.461               	,0.7967839374083772},
{0.47100000000000003 	,0.8004012994899292},
{0.48100000000000004 	,0.8039292049328443},
{0.49100000000000005 	,0.8073709710349352},
{0.52                	,0.8168932390421783},
{0.54                	,0.8230896356775003},
{0.56                	,0.8290066348828963},
{0.5800000000000001  	,0.8346622889882344},
{0.6                 	,0.8400730010379668},
{0.62                	,0.8452537235863792},
{0.64                	,0.8502181279194703},
{0.66                	,0.8549787488862607},
{0.68                	,0.8595471094853037},
{0.7000000000000001  	,0.8639338285468648},
{0.72                	,0.8681487142207702},
{0.74                	,0.8722008454825804},
{0.76                	,0.8760986434755724},
{0.78                	,0.8798499341899142},
{0.8                 	,0.8834620037259546},
{0.8200000000000001  	,0.8869416471824658},
{0.8400000000000001  	,0.890295212042833},
{0.86                	,0.8935286367947376},
{0.88                	,0.8966474854057682},
{0.9                 	,0.8996569781838184},
{0.92                	,0.9025620194734107},
{0.9400000000000001  	,0.9053672225742047},
{0.9600000000000001  	,0.9080769322135783},
{0.98                	,0.9106952448594355},
{1.                  	,0.9132260271207476},
{1.02                	,0.9156729324505966},
{1.04                	,0.9180394163386032},
{1.06                	,0.9203287501558709},
{1.08                	,0.9225440337951801},
{1.1                 	,0.9246882072317059},
{1.12                	,0.9267640611144261},
{1.1400000000000001  	,0.9287742464854094},
{1.1600000000000001  	,0.9307212837128523},
{1.18                	,0.9326075707139568},
{1.2                 	,0.9344353905352114},
{1.22                	,0.9362069183501647},
{1.24                	,0.9379242279282864},
{1.26                	,0.9395892976227792},
{1.28                	,0.9412040159201742},
{1.3                 	,0.9427701865901291},
{1.32                	,0.9442895334699205},
{1.34                	,0.9457637049146796},
{1.36                	,0.947194277941343},
{1.3800000000000001  	,0.9485827620915797},
{1.4000000000000001  	,0.9499306030365232},
{1.42                	,0.951239185943993},
{1.44                	,0.9525098386269478},
{1.46                	,0.9537438344902073},
{1.48                	,0.9549423952909244},
{1.5                 	,0.9561066937269116},
{1.55                	,0.9588748231800635},
{1.6                 	,0.9614521547493332},
{1.6500000000000001  	,0.9638535776840341},
{1.7                 	,0.9660926182529448},
{1.75                	,0.968181589369005},
{1.8                 	,0.9701317205282097},
{1.85                	,0.9719532711095556},
{1.9000000000000001  	,0.973655629541585},
{1.9500000000000002  	,0.9752474004077349},
{2.                  	,0.9767364812135784},
{2.0500000000000003  	,0.9781301302560578},
{2.1                 	,0.9794350268041417},
{2.15                	,0.9806573246112495},
{2.2                 	,0.9818026996240293},
{2.25                	,0.9828763926231104},
{2.3000000000000003  	,0.9838832474241951},
{2.35                	,0.9848277451782416},
{2.4                 	,0.985714035234303},
{2.45                	,0.9865459629652574},
{2.5                 	,0.9873270949031114},
{2.5500000000000003  	,0.9880607414850939},
{2.6                 	,0.9887499776730416},
{2.65                	,0.9893976616754896},
{2.7                 	,0.9900064519734985},
{2.75                	,0.9905788228268423},
{2.8000000000000003  	,0.9911170784161405},
{2.85                	,0.9916233657582801},
{2.9                 	,0.9920996865166855},
{2.95                	,0.9925479078142381},
{3.                  	,0.9929697721446514},
{3.0500000000000003  	,0.9933669064676457},
{3.1                 	,0.9937408305640388},
{3.1500000000000004  	,0.9940929647188501},
{3.2                 	,0.9944246367933611},
{3.25                	,0.9947370887408439},
{3.3000000000000003  	,0.9950314826151101},
{3.35                	,0.9953089061161269},
{3.4000000000000004  	,0.9955703777125925},
{3.45                	,0.9958168513774924},
{3.5                 	,0.9960492209692005},
{3.5500000000000003  	,0.9962683242876138},
{3.6                 	,0.9964749468320659},
{3.6500000000000004  	,0.9966698252852796},
{3.7                 	,0.9968536507454342},
{3.75                	,0.9970270717264265},
{3.8000000000000003  	,0.9971906969446093},
{3.85                	,0.9973450979087205},
{3.9000000000000004  	,0.9974908113282174},
{3.95                	,0.997628341353965},
{4.                  	,0.9977581616640165},
{4.05                	,0.9978807174061672},
{4.1000000000000005  	,0.9979964270079827},
{4.15                	,0.9981056838641242},
{4.2                 	,0.9982088579099969},
{4.25                	,0.9983062970900077},
{4.3                 	,0.9983983287280689},
{4.3500000000000005  	,0.9984852608073668},
{4.4                 	,0.9985673831658696},
{4.45                	,0.9986449686135468},
{4.5                 	,0.9987182739768006},
{4.55                	,0.9987875410752061},
{4.6000000000000005  	,0.9988529976352448},
{4.65                	,0.9989148581453966},
{4.7                 	,0.9989733246565938},
{4.75                	,0.9990285875317694},
{4.8                 	,0.9990808261479478},
{4.8500000000000005  	,0.9991302095540713},
{4.9                 	,0.999176897087527},
{4.95                	,0.9992210389521338},
{5.                  	,0.9992627767601278},
{5.05                	,0.9993022440405351},
{5.1000000000000005  	,0.9993395667161263},
{5.15                	,0.9993748635510065},
{5.2                 	,0.9994082465707482},
{5.25                	,0.9994398214568425},
{5.3                 	,0.9994696879171201},
{5.3500000000000005  	,0.9994979400336819},
{5.4                 	,0.9995246665897698},
{5.45                	,0.9995499513769286},
{5.5                 	,0.999573873483686},
{5.550000000000001   	,0.9995965075669311},
{5.6000000000000005  	,0.9996179241070683},
{5.65                	,0.9996381896479638},
{5.7                 	,0.9996573670226334},
{5.75                	,0.9996755155655485},
{5.800000000000001   	,0.9996926913123979},
{5.8500000000000005  	,0.9997089471880704},
{5.9                 	,0.999724333183583},
{5.95                	,0.9997388965226343},
{6.                  	,0.9997526818184107},
{6.050000000000001   	,0.9997657312212421},
{6.1000000000000005  	,0.999778084557656},
{6.15                	,0.99978977946136},
{6.2                 	,0.9998008514966237},
{6.25                	,0.9998113342745333},
{6.300000000000001   	,0.9998212595625287},
{6.3500000000000005  	,0.9998306573876391},
{6.4                 	,0.9998395561337817},
{6.45                	,0.9998479826334836},
{6.5                 	,0.9998559622543485},
{6.550000000000001   	,0.9998635189805906},
{6.6000000000000005  	,0.9998706754899109},
{6.65                	,0.9998774532260106},
{6.7                 	,0.9998838724669705},
{6.75                	,0.9998899523897653},
{6.800000000000001   	,0.9998957111311185},
{6.8500000000000005  	,0.999901165844922},
{6.9                 	,0.9999063327564145},
{6.95                	,0.9999112272133126},
{7.                  	,0.9999158637340577},
{7.050000000000001   	,0.9999202560533688},
{7.1000000000000005  	,0.9999244171652261},
{7.15                	,0.9999283593634611},
{7.2                 	,0.9999320942800728},
{7.25                	,0.9999356329214072},
{7.300000000000001   	,0.9999389857023198},
{7.3500000000000005  	,0.9999421624784413},
{7.4                 	,0.9999451725766436},
{7.45                	,0.9999480248238245},
{7.5                 	,0.999950727574087},
{7.550000000000001   	,0.9999532887344248},
{7.6000000000000005  	,0.9999557157889799},
{7.65                	,0.9999580158219669},
{7.7                 	,0.9999601955393307},
{7.75                	,0.9999622612892137},
{7.800000000000001   	,0.999964219081295},
{7.8500000000000005  	,0.9999660746050674},
{7.9                 	,0.9999678332471184},
{7.95                	,0.9999695001074517},
{8.                  	,0.999971080014928},
{8.05                	,0.9999725775418525},
{8.1                 	,0.9999739970177707},
{8.15                	,0.999975342542509},
{8.200000000000001   	,0.9999766179985067},
{8.25                	,0.9999778270624736},
{8.3                 	,0.9999789732164157},
{8.35                	,0.9999800597580624},
{8.4                 	,0.9999810898107253},
{8.450000000000001   	,0.9999820663326247},
{8.5                 	,0.999982992125708},
{8.55                	,0.999983869843995},
{8.6                 	,0.9999847020014685},
{8.65                	,0.9999854909795381},
{8.700000000000001   	,0.999986239034104},
{8.75                	,0.9999869483022384},
{8.8                 	,0.9999876208085071},
{8.85                	,0.9999882584709487},
{8.9                 	,0.9999888631067348},
{8.950000000000001   	,0.9999894364375278},
{9.                  	,0.9999899800945434},
{9.05                	,0.9999904956233504},
{9.1                 	,0.9999909844884068},
{9.15                	,0.9999914480773554},
{9.200000000000001   	,0.9999918877050907},
{9.25                	,0.9999923046176031},
{9.3                 	,0.9999926999956257},
{9.35                	,0.9999930749580773},
{9.4                 	,0.9999934305653306},
{9.450000000000001   	,0.9999937678222969},
{9.5                 	,0.9999940876813543},
{9.55                	,0.9999943910451157},
{9.6                 	,0.9999946787690489},
{9.65                	,0.9999949516639617},
{9.700000000000001   	,0.9999952104983498},
{9.75                	,0.999995456000622},
{9.8                 	,0.999995688861209},
{9.85                	,0.9999959097345588},
{9.9                 	,0.9999961192410233},
{9.950000000000001   	,0.9999963179686516},
{10.                 	,0.9999965064748823},
{10.05               	,0.9999966852881496}};

static double upbranch(double x)
{
    double cstInf;
    double d;
    cstInf = 0.239365;
    d = 1.0 - cstInf * exp(-x) / sqrt(x);
    return d;
}

static double bs_invfunc(double y, double lo, double hi, double delta)
{
    double fx, x, flo, fhi;
    double dp;

    fx = 0.0;
    do {
        x = (lo + hi) / 2.0;
        fx = upbranch(x);
        if (fx < y) {
            lo = x + delta;
        } else if (fx > y) {
            hi = x - delta;
        } else {
            dp = x;
            return dp;
        }
    } while (lo < hi);

    flo = upbranch(lo);
    fhi = upbranch(hi);

    if ((fhi - y) < (y - flo)) {
        dp = hi;
        return dp;
    } else {
        dp = lo;
        return dp;
    }
}

static int bs_table(double y)
{
    int hi, lo, x;
    int ip;

    lo = 0;
    hi = nt + 1;

    do {
        x = (int)floor((lo + hi) / 2);
        if (t[x][1] < y) {
            lo = (int)floor(x + 1);
        } else if (t[x][1] > y) {
            hi = (int)floor(x);
        } else {
            ip = (int)floor(x);
            return ip;
        };
    } while (lo < hi);

    if ((t[hi][1] - y) < (y - t[lo][1])) {
        ip = hi;
        return ip;
    } else {
        ip = lo;
        return ip;
    }
}

static double interpolate(int ip, double p)
{
    double intp;
    intp = t[ip - 1][0] + (t[ip][0] - t[ip - 1][0]) * (fabs(p) - t[ip - 1][1]) / (t[ip][1] - t[ip - 1][1]);
    return intp;
}

static double getEnergy(pcg32_random_t *rng, double ec)
{
    double re;
    double lb = 0.21;
    double ub = 0.99999;
    double ran = atrandd_r(rng);

    if (ran <= lb) {
        /* Low energy: 21% of cases, analytical approximation */
        double cst0 = 1.23159;
        re = pow((ran / cst0), 3);
    } else if (ran > ub) {
        //* High energy: 0.001 % of cases, inversion of the upbranch function */
        double mini = 0.0;
        double maxi = 100.0;
        double eps = maxi * 1.0e-4;
        re = bs_invfunc(ran, mini, maxi, eps);
    } else {
        /* Intermediate energy: 79% of cases, table interpolation */
        int ip = bs_table(ran);
        re = interpolate(ip, ran);
        /*printf("%d %lf %lf\n",ip,ran,re);*/
    };

    return re * ec;
}
